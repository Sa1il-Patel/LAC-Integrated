PROJECT_ID="YOUR_PROJECT_ID"
REPO_REGION="us"
REPO="app"
REGION="us-central1"
for ENV in stg prd; do
  gcloud iam service-accounts create run-${ENV}-sa \
    --display-name="Cloud Run runtime SA (${ENV})" \
    --project ${PROJECT_ID}
done

gcloud artifacts repositories create ${REPO} \
  --repository-format=docker \
  --location=${REPO_REGION} \
  --project ${PROJECT_ID}

PROJECT_NUMBER=$(gcloud projects describe ${PROJECT_ID} --format="value(projectNumber)")
CB_SA="${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com"

gcloud artifacts repositories add-iam-policy-binding ${REPO} \
  --location=${REPO_REGION} \
  --member="serviceAccount:${CB_SA}" \
  --role="roles/artifactregistry.writer" \
  --project ${PROJECT_ID}

gcloud projects add-iam-policy-binding ${PROJECT_ID} \
  --member="serviceAccount:${CB_SA}" \
  --role="roles/run.admin"

for ENV in stg prd; do
  gcloud iam service-accounts add-iam-policy-binding run-${ENV}-sa@${PROJECT_ID}.iam.gserviceaccount.com \
    --member="serviceAccount:${CB_SA}" \
    --role="roles/iam.serviceAccountUser" \
    --project ${PROJECT_ID}
done

for ENV in stg prd; do
  gcloud projects add-iam-policy-binding ${PROJECT_ID} \
    --member="serviceAccount:run-${ENV}-sa@${PROJECT_ID}.iam.gserviceaccount.com" \
    --role="roles/secretmanager.secretAccessor"
done
